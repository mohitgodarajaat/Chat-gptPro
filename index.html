<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI - Multimodal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        // PDF.js Worker Configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        gemini: {
                            blue: '#4c8bf5',
                            dark: '#131314',
                            darksec: '#1e1f20',
                            input: '#f0f4f9',
                            inputdark: '#2d2e31'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
        .prose code { font-family: monospace; background: rgba(0,0,0,0.1); padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-size: 0.9em; }
        .dark .prose code { background: rgba(255,255,255,0.1); color: #e5e7eb; }
        
        body { height: 100dvh; overflow: hidden; }
        
        .cursor-blink::after {
            content: '▋';
            animation: blink 1s step-end infinite;
            margin-left: 2px;
            font-size: 0.9em;
        }
        @keyframes blink { 50% { opacity: 0; } }
        
        #loader { position: fixed; inset: 0; z-index: 50; background: white; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
        .dark #loader { background: #131314; color: white; }

        /* File Preview Styles */
        .file-preview-item {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-white dark:bg-gemini-dark text-gray-900 dark:text-gray-100 flex transition-colors duration-200">

    <div id="loader">
        <div class="flex flex-col items-center gap-4">
            <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <div class="text-lg font-medium">Initializing Universal AI...</div>
        </div>
    </div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-gray-50 dark:bg-gemini-darksec transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col border-r border-gray-200 dark:border-gray-700">
        <div class="p-4 flex items-center justify-between">
            <button onclick="createNewChat()" class="flex-1 flex items-center gap-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-3 rounded-full text-sm font-medium transition-colors text-gray-700 dark:text-gray-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                New Chat
            </button>
            <button onclick="toggleSidebar()" class="md:hidden ml-2 p-2 text-gray-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="chat-history-list"></div>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
            <button onclick="openSettings()" class="flex items-center gap-3 w-full p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Settings
            </button>
        </div>
    </aside>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass"></div>

    <main class="flex-1 flex flex-col h-full w-full relative md:ml-72 transition-all duration-300">
        <header class="flex items-center justify-between p-4 md:hidden border-b border-gray-200 dark:border-gray-800 bg-white/90 dark:bg-gemini-dark/90 backdrop-blur sticky top-0 z-20">
            <button onclick="toggleSidebar()" class="text-gray-600 dark:text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <span class="font-semibold text-lg">Universal AI</span>
            <div class="w-6"></div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
            <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-center text-gray-400 space-y-4">
                <div class="text-5xl">✨</div>
                <h2 class="text-2xl font-semibold text-gray-600 dark:text-gray-300">How can I help you today?</h2>
            </div>
        </div>

        <div class="p-4 bg-white dark:bg-gemini-dark">
            <div class="max-w-4xl mx-auto relative group">
                
                <div id="file-preview-area" class="flex flex-wrap gap-2 mb-2 px-2 hidden">
                    </div>

                <div class="bg-gemini-input dark:bg-gemini-inputdark rounded-3xl p-2 flex items-end gap-2 border border-transparent focus-within:border-gray-300 dark:focus-within:border-gray-600 transition-colors">
                    
                    <button onclick="document.getElementById('file-upload').click()" class="p-2 mb-1 text-gray-500 hover:text-gray-700 dark:hover:text-gray-200 transition-colors rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                    </button>
                    <input type="file" id="file-upload" class="hidden" multiple onchange="handleFileSelect(event)" accept="image/*,.pdf,.txt,.md,.js,.py,.html,.css,.json">

                    <textarea id="user-input" rows="1" class="w-full bg-transparent border-none focus:ring-0 resize-none max-h-32 py-3 px-2 text-base text-gray-900 dark:text-white placeholder-gray-500" placeholder="Message Universal AI..."></textarea>
                    
                    <button id="send-btn" onclick="handleSend()" class="p-2 mb-1 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex-shrink-0">
                        <svg class="w-5 h-5 transform rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSettings()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-gemini-darksec rounded-2xl shadow-2xl p-6 border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4">Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">OpenRouter API Key</label>
                    <input type="password" id="setting-api-key" placeholder="sk-or-..." class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Model ID (Supports Vision)</label>
                    <input type="text" id="setting-model" value="google/gemini-2.0-flash-lite-preview-02-05:free" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 outline-none">
                    <p class="text-xs text-gray-500 mt-1">Rec: google/gemini-2.0... or openai/gpt-4o</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">System Prompt</label>
                    <textarea id="setting-system-prompt" rows="3" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 outline-none text-sm"></textarea>
                </div>
                <div class="flex items-center justify-between pt-2">
                    <span class="text-sm font-medium">Dark Mode</span>
                    <button onclick="toggleDarkMode()" class="text-blue-500 font-medium">Toggle</button>
                </div>
                <div class="pt-4 flex gap-2">
                    <button onclick="saveSettings()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg">Save</button>
                    <button onclick="clearAllData()" class="flex-1 bg-red-100 text-red-600 rounded-lg">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. STATE & VARS
        // ==========================================
        // Updated default to a model that handles images well and is free
        const DEFAULT_MODEL = "google/gemini-2.0-flash-lite-preview-02-05:free";
        const DEFAULT_SYSTEM = "You are a helpful, smart, and concise AI assistant.";

        let state = {
            apiKey: "",
            model: DEFAULT_MODEL,
            systemPrompt: DEFAULT_SYSTEM,
            darkMode: false,
            chats: [],
            currentChatId: null
        };

        // File Staging Area
        let pendingFiles = []; // Array of { type: 'image'|'text', content: '...', name: '...' }

        const els = {
            loader: document.getElementById('loader'),
            chatContainer: document.getElementById('chat-container'),
            userInput: document.getElementById('user-input'),
            sidebar: document.getElementById('sidebar'),
            historyList: document.getElementById('chat-history-list'),
            settingsModal: document.getElementById('settings-modal'),
            apiKeyInput: document.getElementById('setting-api-key'),
            modelInput: document.getElementById('setting-model'),
            systemPromptInput: document.getElementById('setting-system-prompt'),
            overlay: document.getElementById('sidebar-overlay'),
            sendBtn: document.getElementById('send-btn'),
            welcome: document.getElementById('welcome-message'),
            filePreview: document.getElementById('file-preview-area'),
            fileInput: document.getElementById('file-upload')
        };

        // ==========================================
        // 2. INIT & STORAGE
        // ==========================================
        function init() {
            const savedState = localStorage.getItem('universal-ai-state');
            if (savedState) state = { ...state, ...JSON.parse(savedState) };
            
            applyTheme();
            if (state.chats.length === 0) createNewChat(false);
            else if (!state.currentChatId) state.currentChatId = state.chats[0].id;

            renderSidebar();
            renderChat();

            setTimeout(() => {
                els.loader.style.opacity = '0';
                setTimeout(() => els.loader.style.display = 'none', 500);
            }, 500);
        }

        function saveState() {
            localStorage.setItem('universal-ai-state', JSON.stringify(state));
        }

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

        // ==========================================
        // 3. FILE HANDLING (CORE FEATURE)
        // ==========================================
        
        async function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            if(files.length === 0) return;

            // Show a mini loader cursor
            document.body.style.cursor = 'wait';

            for (const file of files) {
                try {
                    if (file.type.startsWith('image/')) {
                        await processImage(file);
                    } else if (file.type === 'application/pdf') {
                        await processPdf(file);
                    } else {
                        // Assume text/code
                        await processTextFile(file);
                    }
                } catch (err) {
                    alert(`Error processing ${file.name}: ${err.message}`);
                }
            }
            
            document.body.style.cursor = 'default';
            els.fileInput.value = ''; // Reset input
            renderFilePreviews();
        }

        function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    pendingFiles.push({
                        type: 'image',
                        name: file.name,
                        content: e.target.result // Base64
                    });
                    resolve();
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function processTextFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    pendingFiles.push({
                        type: 'text',
                        name: file.name,
                        content: e.target.result
                    });
                    resolve();
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        // PDF Extraction using pdf.js
        async function processPdf(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = "";
                
                // Limit pages to prevent browser crash on huge PDFs
                const maxPages = Math.min(pdf.numPages, 10); 
                
                for (let i = 1; i <= maxPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += `--- Page ${i} ---\n${pageText}\n\n`;
                }

                if(pdf.numPages > 10) fullText += "\n[...PDF Truncated after 10 pages...]";

                pendingFiles.push({
                    type: 'text', // Treated as text for the LLM
                    name: file.name,
                    content: fullText,
                    isPdf: true
                });

            } catch (e) {
                console.error(e);
                throw new Error("Could not parse PDF. Make sure it's not password protected.");
            }
        }

        function renderFilePreviews() {
            els.filePreview.innerHTML = '';
            if (pendingFiles.length === 0) {
                els.filePreview.classList.add('hidden');
                return;
            }
            els.filePreview.classList.remove('hidden');

            pendingFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = "file-preview-item relative group w-16 h-16 rounded-lg border border-gray-300 dark:border-gray-600 overflow-hidden bg-gray-100 dark:bg-gray-800 flex items-center justify-center";
                
                if (file.type === 'image') {
                    div.innerHTML = `<img src="${file.content}" class="w-full h-full object-cover">`;
                } else {
                    div.innerHTML = `<span class="text-xs font-bold text-gray-500 uppercase">${file.name.split('.').pop().slice(0,3)}</span>`;
                }

                // Remove Button
                const btn = document.createElement('button');
                btn.className = "absolute top-0 right-0 bg-red-500 text-white rounded-bl-lg p-0.5 opacity-0 group-hover:opacity-100 transition-opacity";
                btn.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                btn.onclick = () => removeFile(index);

                div.appendChild(btn);
                els.filePreview.appendChild(div);
            });
        }

        function removeFile(index) {
            pendingFiles.splice(index, 1);
            renderFilePreviews();
        }

        // ==========================================
        // 4. CHAT LOGIC (UPDATED FOR MULTIMODAL)
        // ==========================================
        
        async function handleSend() {
            const text = els.userInput.value.trim();
            if (!text && pendingFiles.length === 0) return;
            
            if(!state.apiKey) { alert("Set API Key in Settings."); openSettings(); return; }

            // UI Reset
            els.userInput.value = '';
            els.userInput.style.height = 'auto';
            els.filePreview.classList.add('hidden');
            els.sendBtn.disabled = true;

            const chat = state.chats.find(c => c.id === state.currentChatId);
            
            // --- CONSTRUCT MESSAGE PAYLOAD ---
            
            // 1. Separate Images and Text
            const images = pendingFiles.filter(f => f.type === 'image');
            const textFiles = pendingFiles.filter(f => f.type === 'text');
            
            let messageContent = [];

            // 2. Add User Text + File Text Context
            let fullText = text;
            if (textFiles.length > 0) {
                fullText += "\n\n--- ATTACHED FILES ---\n";
                textFiles.forEach(f => {
                    fullText += `[File: ${f.name}]\n${f.content}\n\n`;
                });
            }

            // 3. Format for API (Multimodal Array or Simple String)
            if (images.length > 0) {
                // Multimodal format
                messageContent.push({ type: "text", text: fullText });
                images.forEach(img => {
                    messageContent.push({
                        type: "image_url",
                        image_url: { url: img.content } // Base64
                    });
                });
            } else {
                // Text-only format (simpler)
                messageContent = fullText; 
            }

            // Add to Local Chat History (Store purely as text/html representation for display)
            // Note: We don't store base64 in localstorage history heavily to save space, 
            // but for this zero-build version, we will store a simplified version.
            const displayContent = fullText + (images.length ? `\n\n*[Attached ${images.length} Image(s)]*` : "");
            
            chat.messages.push({ role: 'user', content: displayContent, _apiPayload: messageContent }); // Store payload for context logic if needed
            
            // Clear pending
            pendingFiles = [];
            
            if (chat.messages.length === 1 && text) {
                chat.title = text.slice(0, 30);
                renderSidebar();
            }

            saveState();
            renderChat();

            // Prepare AI Response UI
            const aiContainer = appendMessageToUI('assistant', '', true);
            aiContainer.innerHTML = '<span class="cursor-blink"></span>';
            scrollToBottom();

            try {
                // Construct API Messages Array
                // We need to be careful: Previous messages in history might be strings. 
                // If this is the *current* message, use the multimodal object.
                const apiMessages = [
                    { role: "system", content: state.systemPrompt },
                    ...chat.messages.slice(0, -1).map(m => ({ role: m.role, content: m.content })), // Send history as text to save tokens/complexity
                    { role: "user", content: messageContent } // Current Multi-modal message
                ];

                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: apiMessages,
                        stream: true
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let fullResponse = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.replace('data: ', '').trim();
                            if (dataStr === '[DONE]') break;
                            try {
                                const data = JSON.parse(dataStr);
                                const token = data.choices[0]?.delta?.content || "";
                                if (token) {
                                    fullResponse += token;
                                    aiContainer.innerHTML = marked.parse(fullResponse) + '<span class="cursor-blink"></span>';
                                    scrollToBottom();
                                }
                            } catch (e) {}
                        }
                    }
                }

                aiContainer.querySelector('.cursor-blink')?.remove();
                chat.messages.push({ role: 'assistant', content: fullResponse });
                saveState();

            } catch (err) {
                aiContainer.innerHTML += `<br><span class="text-red-500 text-sm">Error: ${err.message}</span>`;
                chat.messages.push({ role: 'assistant', content: "Error generating response." });
            } finally {
                els.sendBtn.disabled = false;
            }
        }

        // ==========================================
        // 5. STANDARD UI FUNCTIONS
        // ==========================================
        function createNewChat(render = true) {
            const newChat = { id: generateId(), title: "New Chat", messages: [] };
            state.chats.unshift(newChat);
            state.currentChatId = newChat.id;
            saveState();
            if (render) { renderSidebar(); renderChat(); if (window.innerWidth < 768) toggleSidebar(); }
        }

        function switchChat(id) {
            state.currentChatId = id;
            saveState();
            renderSidebar();
            renderChat();
            if (window.innerWidth < 768) toggleSidebar();
        }

        function renderSidebar() {
            els.historyList.innerHTML = '';
            state.chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-2 rounded-full cursor-pointer text-sm ${isActive ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' : 'hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-300'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden" onclick="switchChat('${chat.id}')">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                        <span class="truncate">${escapeHtml(chat.title || "New Chat")}</span>
                    </div>
                    ${isActive ? `<button onclick="deleteChat('${chat.id}', event)" class="p-1 hover:text-red-500 rounded hidden group-hover:block"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>` : ''}
                `;
                els.historyList.appendChild(div);
            });
        }

        function renderChat() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            els.chatContainer.innerHTML = '';
            if (!chat || chat.messages.length === 0) { els.chatContainer.appendChild(els.welcome); return; }
            chat.messages.forEach(msg => appendMessageToUI(msg.role, msg.content));
            scrollToBottom();
        }

        function appendMessageToUI(role, content) {
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;
            const contentHtml = isUser ? escapeHtml(content).replace(/\n/g, '<br>') : marked.parse(content);
            
            div.innerHTML = `
                <div class="max-w-[85%] md:max-w-[75%] flex gap-3 ${isUser ? 'flex-row-reverse' : 'flex-row'}">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${isUser ? 'bg-gray-200 dark:bg-gray-700' : 'bg-gradient-to-br from-blue-500 to-purple-600'}">
                        ${isUser ? '<span class="text-xs">You</span>' : '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>'}
                    </div>
                    <div class="prose dark:prose-invert text-sm md:text-base ${isUser ? 'bg-gray-100 dark:bg-gray-800 rounded-2xl px-4 py-2' : 'px-1 pt-1'}">
                        ${isUser ? contentHtml : `<div class="ai-content">${contentHtml}</div>`}
                    </div>
                </div>
            `;
            els.chatContainer.appendChild(div);
            return div.querySelector('.ai-content');
        }

        function deleteChat(id, e) {
            e.stopPropagation();
            if(!confirm("Delete chat?")) return;
            state.chats = state.chats.filter(c => c.id !== id);
            if(state.chats.length === 0) createNewChat(false);
            else state.currentChatId = state.chats[0].id;
            saveState(); renderSidebar(); renderChat();
        }

        function toggleSidebar() { els.sidebar.classList.toggle('-translate-x-full'); els.overlay.classList.toggle('hidden'); }
        function openSettings() { els.apiKeyInput.value = state.apiKey; els.modelInput.value = state.model; els.systemPromptInput.value = state.systemPrompt; els.settingsModal.classList.remove('hidden'); }
        function closeSettings() { els.settingsModal.classList.add('hidden'); }
        function saveSettings() { state.apiKey = els.apiKeyInput.value; state.model = els.modelInput.value; state.systemPrompt = els.systemPromptInput.value; saveState(); closeSettings(); }
        function toggleDarkMode() { state.darkMode = !state.darkMode; applyTheme(); saveState(); }
        function applyTheme() { document.documentElement.classList.toggle('dark', state.darkMode); }
        function clearAllData() { if(confirm("Clear all?")) { localStorage.removeItem('universal-ai-state'); location.reload(); } }
        function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }
        function scrollToBottom() { els.chatContainer.scrollTop = els.chatContainer.scrollHeight; }

        els.userInput.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
        els.userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
